{% extends "base_admin.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<style>
    /* Estilos modernos para el dashboard */

    /* Contenedor del dashboard sin padding superior */
    .container-fluid {
        padding-top: 30px;
    }

    .dashboard-header {
        background: linear-gradient(135deg, #1ABC9C 0%, #16A085 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 10px 40px rgba(26, 188, 156, 0.3);
    }

    .dashboard-header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .dashboard-header p {
        font-size: 1.1rem;
        opacity: 0.95;
        margin: 0;
    }

    /* Botones de exportación modernos */
    .export-buttons {
        display: flex;
        gap: 12px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .btn-export {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.4);
        color: white;
        padding: 12px 24px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 0.95rem;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .btn-export:hover {
        background: white;
        color: #16A085;
        border-color: white;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .btn-export i {
        font-size: 1.2rem;
        transition: transform 0.3s ease;
    }

    .btn-export:hover i {
        transform: scale(1.2);
    }

    .btn-export.pdf {
        background: rgba(231, 76, 60, 0.15);
        border-color: rgba(231, 76, 60, 0.4);
    }

    .btn-export.pdf:hover {
        background: #E74C3C;
        color: white;
        border-color: #E74C3C;
    }

    .btn-export.excel {
        background: rgba(39, 174, 96, 0.15);
        border-color: rgba(39, 174, 96, 0.4);
    }

    .btn-export.excel:hover {
        background: #27AE60;
        color: white;
        border-color: #27AE60;
    }

    /* Tarjetas de estadísticas mejoradas */
    .stat-card-modern {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: 3px solid transparent;
        position: relative;
        overflow: hidden;
        height: 100%;
    }

    .stat-card-modern::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(135deg, var(--color), var(--color-dark));
    }

    .stat-card-modern.verde {
        --color: #1ABC9C;
        --color-dark: #16A085;
    }

    .stat-card-modern.naranja {
        --color: #F39C12;
        --color-dark: #E67E22;
    }

    .stat-card-modern.azul {
        --color: #3498DB;
        --color-dark: #2980B9;
    }

    .stat-card-modern.morado {
        --color: #9B59B6;
        --color-dark: #8E44AD;
    }

    .stat-card-modern:hover {
        transform: translateY(-10px);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        border-color: var(--color);
    }

    .stat-card-icon {
        width: 70px;
        height: 70px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
        background: linear-gradient(135deg, var(--color), var(--color-dark));
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .stat-card-icon i {
        font-size: 35px;
        color: white;
    }

    .stat-card-modern h3 {
        font-size: 2.8rem;
        font-weight: 800;
        color: #2C3E50;
        margin: 15px 0;
    }

    .stat-card-modern p {
        color: #7F8C8D;
        font-size: 1rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 15px;
    }

    .stat-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        background: rgba(26, 188, 156, 0.1);
        color: #16A085;
    }

    /* Tarjetas de gráficos */
    .chart-card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
        transition: all 0.3s ease;
    }

    .chart-card:hover {
        box-shadow: 0 15px 50px rgba(0, 0, 0, 0.12);
    }

    .chart-card h4 {
        font-size: 1.4rem;
        font-weight: 700;
        color: #2C3E50;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .chart-card h4 i {
        color: #1ABC9C;
        font-size: 1.6rem;
    }

    /* Botones de acción rápida */
    .action-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }

    .action-btn {
        background: white;
        border-radius: 15px;
        padding: 25px;
        text-decoration: none;
        color: #2C3E50;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        transition: all 0.3s ease;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        border: 3px solid transparent;
    }

    .action-btn:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 40px rgba(26, 188, 156, 0.2);
        border-color: #1ABC9C;
        color: #1ABC9C;
    }

    .action-btn i {
        font-size: 3rem;
        color: #1ABC9C;
        transition: all 0.3s ease;
    }

    .action-btn:hover i {
        transform: scale(1.15);
    }

    .action-btn span {
        font-weight: 700;
        font-size: 1.05rem;
    }

    /* Tabla de top pruebas */
    .top-pruebas-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .top-pruebas-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: #F8F9FA;
        border-radius: 10px;
        margin-bottom: 12px;
        transition: all 0.3s ease;
    }

    .top-pruebas-list li:hover {
        background: rgba(26, 188, 156, 0.1);
        transform: translateX(10px);
    }

    .prueba-nombre {
        font-weight: 600;
        color: #2C3E50;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .prueba-nombre i {
        color: #1ABC9C;
    }

    .prueba-count {
        background: linear-gradient(135deg, #1ABC9C, #16A085);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 0.95rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .dashboard-header h1 {
            font-size: 1.8rem;
        }

        .stat-card-modern h3 {
            font-size: 2rem;
        }

        .action-buttons {
            grid-template-columns: 1fr;
        }

        .export-buttons {
            flex-direction: column;
            width: 100%;
        }

        .btn-export {
            width: 100%;
            justify-content: center;
        }
    }
</style>

<div class="container-fluid">
    <!-- Header del Dashboard -->
    <div class="dashboard-header">
        <h1>
            <i class="fas fa-chart-line"></i>
            Dashboard Administrativo
        </h1>
        <p><i class="fas fa-map-marker-alt"></i> Laboratorio Pérez - Potosí, Bolivia</p>

        <!-- Botones de Exportación -->
        <div class="export-buttons">
            <button onclick="exportarPDF()" class="btn-export pdf">
                <i class="fas fa-file-pdf"></i>
                Exportar PDF
            </button>
            <button onclick="exportarExcel()" class="btn-export excel">
                <i class="fas fa-file-excel"></i>
                Exportar Excel
            </button>
        </div>
    </div>

    <!-- Tarjetas de Estadísticas -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stat-card-modern verde">
                <div class="stat-card-icon">
                    <i class="fas fa-users"></i>
                </div>
                <h3>{{ total_pacientes }}</h3>
                <p>Total Pacientes</p>
                <span class="stat-badge">
                    <i class="fas fa-plus-circle"></i> {{ pacientes_este_mes }} este mes
                </span>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stat-card-modern naranja">
                <div class="stat-card-icon">
                    <i class="fas fa-file-medical"></i>
                </div>
                <h3>{{ total_resultados }}</h3>
                <p>Total Resultados</p>
                <span class="stat-badge">
                    <i class="fas fa-plus-circle"></i> {{ resultados_este_mes }} este mes
                </span>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stat-card-modern azul">
                <div class="stat-card-icon">
                    <i class="fas fa-vial"></i>
                </div>
                <h3>{{ total_pruebas }}</h3>
                <p>Pruebas Disponibles</p>
                <span class="stat-badge">
                    <i class="fas fa-check-circle"></i> Activas
                </span>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stat-card-modern morado">
                <div class="stat-card-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <h3>{{ pacientes_este_mes + resultados_este_mes }}</h3>
                <p>Actividad del Mes</p>
                <span class="stat-badge">
                    <i class="fas fa-trending-up"></i> Total
                </span>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row mb-4">
        <div class="col-lg-8 mb-4">
            <div class="chart-card">
                <h4>
                    <i class="fas fa-chart-area"></i>
                    Tendencia de Pacientes y Resultados
                </h4>
                <canvas id="trendChart" style="max-height: 350px;"></canvas>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="chart-card">
                <h4>
                    <i class="fas fa-flask"></i>
                    Últimas Pruebas
                </h4>
                {% if top_pruebas %}
                <ul class="top-pruebas-list">
                    {% for prueba, precio in top_pruebas %}
                    <li>
                        <span class="prueba-nombre">
                            <i class="fas fa-vial"></i>
                            {{ prueba }}
                        </span>
                        <span class="prueba-count">Bs. {{ "%.2f"|format(precio) }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted text-center py-4">
                    <i class="fas fa-info-circle"></i> No hay pruebas disponibles
                </p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Gráfico de Distribución -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="chart-card">
                <h4>
                    <i class="fas fa-chart-pie"></i>
                    Distribución General
                </h4>
                <canvas id="distributionChart" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="chart-card">
                <h4>
                    <i class="fas fa-chart-bar"></i>
                    Comparación Mensual
                </h4>
                <canvas id="comparisonChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>

    <!-- Acciones Rápidas -->
    <div class="chart-card">
        <h4>
            <i class="fas fa-bolt"></i>
            Acciones Rápidas
        </h4>
        <div class="action-buttons">
            <a href="{{ url_for('main.admin_pacientes') }}" class="action-btn">
                <i class="fas fa-users"></i>
                <span>Gestionar Pacientes</span>
            </a>
            <a href="{{ url_for('main.admin_resultados') }}" class="action-btn">
                <i class="fas fa-file-upload"></i>
                <span>Subir Resultado</span>
            </a>
            <a href="{{ url_for('main.admin_pruebas') }}" class="action-btn">
                <i class="fas fa-flask"></i>
                <span>Gestionar Pruebas</span>
            </a>
            <a href="{{ url_for('main.index') }}" class="action-btn" target="_blank">
                <i class="fas fa-globe"></i>
                <span>Ver Sitio Público</span>
            </a>
        </div>
    </div>
</div>

<!-- Datos del servidor (formato JSON en elemento HTML) -->
<div id="dashboard-data" style="display:none;"
     data-ultimos-meses='{{ ultimos_meses | tojson | safe }}'
     data-pacientes-data='{{ pacientes_data | tojson | safe }}'
     data-resultados-data='{{ resultados_data | tojson | safe }}'
     data-total-pacientes='{{ total_pacientes }}'
     data-total-resultados='{{ total_resultados }}'
     data-total-pruebas='{{ total_pruebas }}'>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Librerías para exportación -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Lógica del dashboard -->
<script src="{{ url_for('static', filename='js/admin/dashboard.js') }}"></script>

<!-- Script de exportación -->
<script>
// Función para exportar a PDF
async function exportarPDF() {
    const { jsPDF } = window.jspdf;

    // Mostrar indicador de carga
    const btnPDF = event.target.closest('.btn-export');
    const originalHTML = btnPDF.innerHTML;
    btnPDF.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando PDF...';
    btnPDF.disabled = true;

    try {
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const margin = 15;
        let yPosition = margin;

        // Función auxiliar para agregar texto
        const addText = (text, size, isBold = false) => {
            pdf.setFontSize(size);
            pdf.setFont(undefined, isBold ? 'bold' : 'normal');
            pdf.text(text, margin, yPosition);
            yPosition += size * 0.5;
        };

        // Header del PDF
        pdf.setFillColor(26, 188, 156);
        pdf.rect(0, 0, pageWidth, 40, 'F');

        pdf.setTextColor(255, 255, 255);
        pdf.setFontSize(22);
        pdf.setFont(undefined, 'bold');
        pdf.text('Dashboard - Laboratorio Pérez', margin, 20);

        pdf.setFontSize(12);
        pdf.setFont(undefined, 'normal');
        const fecha = new Date().toLocaleDateString('es-BO', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        pdf.text(`Potosí, Bolivia - ${fecha}`, margin, 30);

        yPosition = 50;
        pdf.setTextColor(0, 0, 0);

        // Estadísticas generales
        pdf.setFontSize(16);
        pdf.setFont(undefined, 'bold');
        pdf.text('ESTADISTICAS GENERALES', margin, yPosition);
        yPosition += 10;

        const stats = [
            { label: 'Total Pacientes', value: '{{ total_pacientes }}', color: [26, 188, 156] },
            { label: 'Total Resultados', value: '{{ total_resultados }}', color: [243, 156, 18] },
            { label: 'Pruebas Disponibles', value: '{{ total_pruebas }}', color: [52, 152, 219] },
            { label: 'Pacientes Este Mes', value: '{{ pacientes_este_mes }}', color: [155, 89, 182] }
        ];

        stats.forEach(stat => {
            pdf.setDrawColor(stat.color[0], stat.color[1], stat.color[2]);
            pdf.setLineWidth(0.5);
            pdf.line(margin, yPosition, margin + 50, yPosition);

            pdf.setFontSize(11);
            pdf.setTextColor(100, 100, 100);
            pdf.text(stat.label, margin, yPosition + 5);

            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(stat.color[0], stat.color[1], stat.color[2]);
            pdf.text(stat.value, margin + 55, yPosition + 5);

            yPosition += 12;
        });

        yPosition += 10;

        // Capturar gráfico de tendencias
        const trendCanvas = document.getElementById('trendChart');
        if (trendCanvas) {
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(0, 0, 0);
            pdf.text('TENDENCIA DE PACIENTES Y RESULTADOS', margin, yPosition);
            yPosition += 8;

            const trendImage = trendCanvas.toDataURL('image/png');
            const imgWidth = pageWidth - (margin * 2);
            const imgHeight = (trendCanvas.height * imgWidth) / trendCanvas.width;

            if (yPosition + imgHeight > pageHeight - margin) {
                pdf.addPage();
                yPosition = margin;
            }

            pdf.addImage(trendImage, 'PNG', margin, yPosition, imgWidth, imgHeight);
            yPosition += imgHeight + 10;
        }

        // Nueva página para distribución
        pdf.addPage();
        yPosition = margin;

        // Capturar gráfico de distribución
        const distCanvas = document.getElementById('distributionChart');
        if (distCanvas) {
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('DISTRIBUCION GENERAL', margin, yPosition);
            yPosition += 8;

            const distImage = distCanvas.toDataURL('image/png');
            const imgWidth = (pageWidth - (margin * 2)) / 2 - 5;
            const imgHeight = (distCanvas.height * imgWidth) / distCanvas.width;

            pdf.addImage(distImage, 'PNG', margin, yPosition, imgWidth, imgHeight);
        }

        // Capturar gráfico de comparación
        const compCanvas = document.getElementById('comparisonChart');
        if (compCanvas) {
            const compImage = compCanvas.toDataURL('image/png');
            const imgWidth = (pageWidth - (margin * 2)) / 2 - 5;
            const imgHeight = (compCanvas.height * imgWidth) / compCanvas.width;

            pdf.addImage(compImage, 'PNG', pageWidth / 2 + 5, yPosition, imgWidth, imgHeight);
        }

        // Footer
        const totalPages = pdf.internal.pages.length - 1;
        for (let i = 1; i <= totalPages; i++) {
            pdf.setPage(i);
            pdf.setFontSize(9);
            pdf.setTextColor(150, 150, 150);
            pdf.text(
                `Página ${i} de ${totalPages} - Generado por Sistema Laboratorio Pérez`,
                pageWidth / 2,
                pageHeight - 10,
                { align: 'center' }
            );
        }

        // Guardar PDF
        pdf.save(`Dashboard_Laboratorio_Perez_${new Date().toISOString().split('T')[0]}.pdf`);

        // Restaurar botón
        btnPDF.innerHTML = '<i class="fas fa-check"></i> PDF Generado!';
        setTimeout(() => {
            btnPDF.innerHTML = originalHTML;
            btnPDF.disabled = false;
        }, 2000);

    } catch (error) {
        console.error('Error generando PDF:', error);
        alert('Error al generar el PDF. Por favor, intente nuevamente.');
        btnPDF.innerHTML = originalHTML;
        btnPDF.disabled = false;
    }
}

// Función para exportar a Excel
function exportarExcel() {
    const btnExcel = event.target.closest('.btn-export');
    const originalHTML = btnExcel.innerHTML;
    btnExcel.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando Excel...';
    btnExcel.disabled = true;

    try {
        // Crear libro de Excel
        const wb = XLSX.utils.book_new();

        // Hoja 1: Estadísticas Generales - CON ESTILOS MODERNOS
        const statsData = [
            ['DASHBOARD - LABORATORIO CLINICO PEREZ'],
            ['Potosi, Bolivia'],
            ['Fecha de Reporte:', new Date().toLocaleDateString('es-BO', {day: '2-digit', month: 'long', year: 'numeric'})],
            [],
            ['ESTADISTICAS GENERALES DEL SISTEMA'],
            [],
            ['Metrica', 'Valor Actual', 'Este Mes', 'Estado'],
            ['Total Pacientes', {{ total_pacientes }}, {{ pacientes_este_mes }}, 'Activo'],
            ['Total Resultados', {{ total_resultados }}, {{ resultados_este_mes }}, 'Activo'],
            ['Pruebas Disponibles', {{ total_pruebas }}, '-', 'Catalogo Completo'],
            ['Actividad Mensual', {{ pacientes_este_mes + resultados_este_mes }}, {{ pacientes_este_mes + resultados_este_mes }}, 'En Progreso'],
            [],
            [],
            ['RESUMEN EJECUTIVO'],
            [],
            ['Categoria', 'Descripcion', 'Valor'],
            ['Crecimiento', 'Nuevos pacientes este mes', {{ pacientes_este_mes }}],
            ['Productividad', 'Nuevos resultados este mes', {{ resultados_este_mes }}],
            ['Servicios', 'Pruebas de laboratorio activas', {{ total_pruebas }}],
            ['Base de Datos', 'Total registros de pacientes', {{ total_pacientes }}]
        ];

        const wsStats = XLSX.utils.aoa_to_sheet(statsData);

        // Columnas con anchos optimizados
        wsStats['!cols'] = [
            { width: 35 },  // Columna A - Métrica
            { width: 18 },  // Columna B - Valor
            { width: 18 },  // Columna C - Este mes
            { width: 20 }   // Columna D - Estado
        ];

        // Altura de filas
        wsStats['!rows'] = [
            { hpt: 25 },  // Fila 1 - Título
            { hpt: 18 },  // Fila 2
            { hpt: 18 },  // Fila 3
            { hpt: 10 },  // Fila 4 - espacio
            { hpt: 22 },  // Fila 5 - Subtítulo
        ];

        // Merge cells para títulos
        wsStats['!merges'] = [
            { s: { r: 0, c: 0 }, e: { r: 0, c: 3 } },  // Título principal
            { s: { r: 4, c: 0 }, e: { r: 4, c: 3 } },  // Subtítulo estadísticas
            { s: { r: 13, c: 0 }, e: { r: 13, c: 2 } }  // Resumen ejecutivo
        ];

        XLSX.utils.book_append_sheet(wb, wsStats, 'Dashboard');

        // Hoja 2: Tendencias Mensuales - MEJORADA
        const mesesData = {{ ultimos_meses | tojson | safe }};
        const pacientesData = {{ pacientes_data | tojson | safe }};
        const resultadosData = {{ resultados_data | tojson | safe }};

        const trendData = [
            ['ANALISIS DE TENDENCIAS - LABORATORIO PEREZ'],
            [],
            ['Periodo de Analisis:', 'Ultimos 6 meses'],
            [],
            ['Mes', 'Nuevos Pacientes', 'Nuevos Resultados', 'Total Actividad', 'Tendencia'],
        ];

        // Calcular datos con análisis
        for (let i = 0; i < mesesData.length; i++) {
            const totalActividad = pacientesData[i] + resultadosData[i];
            let tendencia = 'Estable';

            if (i > 0) {
                const actividadAnterior = pacientesData[i-1] + resultadosData[i-1];
                if (totalActividad > actividadAnterior) tendencia = 'Creciendo';
                else if (totalActividad < actividadAnterior) tendencia = 'Descendiendo';
            }

            trendData.push([
                mesesData[i],
                pacientesData[i],
                resultadosData[i],
                totalActividad,
                tendencia
            ]);
        }

        // Agregar totales y promedios
        const totalPacientesPeriodo = pacientesData.reduce((a, b) => a + b, 0);
        const totalResultadosPeriodo = resultadosData.reduce((a, b) => a + b, 0);
        const promedioPacientes = Math.round(totalPacientesPeriodo / mesesData.length);
        const promedioResultados = Math.round(totalResultadosPeriodo / mesesData.length);

        trendData.push([]);
        trendData.push(['RESUMEN DEL PERIODO']);
        trendData.push(['Total Pacientes:', totalPacientesPeriodo, 'Promedio Mensual:', promedioPacientes]);
        trendData.push(['Total Resultados:', totalResultadosPeriodo, 'Promedio Mensual:', promedioResultados]);

        const wsTrend = XLSX.utils.aoa_to_sheet(trendData);
        wsTrend['!cols'] = [
            { width: 20 },  // Mes
            { width: 20 },  // Nuevos Pacientes
            { width: 20 },  // Nuevos Resultados
            { width: 18 },  // Total Actividad
            { width: 18 }   // Tendencia
        ];

        // Merge cells
        wsTrend['!merges'] = [
            { s: { r: 0, c: 0 }, e: { r: 0, c: 4 } }  // Título
        ];

        XLSX.utils.book_append_sheet(wb, wsTrend, 'Tendencias Mensuales');

        // Hoja 3: Catálogo de Pruebas - PROFESIONAL
        {% if top_pruebas %}
        const pruebasData = [
            ['CATALOGO DE PRUEBAS DE LABORATORIO'],
            ['Laboratorio Clinico Perez - Potosi, Bolivia'],
            [],
            ['Precio actualizado al:', new Date().toLocaleDateString('es-BO', {day: '2-digit', month: 'long', year: 'numeric'})],
            [],
            ['No.', 'Nombre de la Prueba', 'Precio (Bs.)', 'Estado', 'Observaciones']
        ];

        let numeroLinea = 1;
        {% for prueba, precio in top_pruebas %}
        pruebasData.push([
            numeroLinea,
            '{{ prueba }}',
            {{ precio if precio else 0 }},
            {{ precio }} > 0 ? 'Con Precio' : 'Consultar',
            {{ precio }} > 0 ? 'Precio disponible' : 'El doctor debe establecer precio'
        ]);
        numeroLinea++;
        {% endfor %}

        // Agregar resumen
        pruebasData.push([]);
        pruebasData.push(['RESUMEN DEL CATALOGO']);
        pruebasData.push(['Total de Pruebas:', {{ top_pruebas|length }}]);
        pruebasData.push(['Pruebas con precio definido:', 'Se calculan automaticamente']);
        pruebasData.push([]);
        pruebasData.push(['NOTA IMPORTANTE:']);
        pruebasData.push(['Los precios se establecen manualmente desde el panel administrativo.']);
        pruebasData.push(['Si una prueba muestra 0.00, el precio debe ser consultado con el laboratorio.']);

        const wsPruebas = XLSX.utils.aoa_to_sheet(pruebasData);
        wsPruebas['!cols'] = [
            { width: 8 },   // No.
            { width: 50 },  // Nombre prueba
            { width: 15 },  // Precio
            { width: 18 },  // Estado
            { width: 35 }   // Observaciones
        ];

        // Merge cells para títulos
        wsPruebas['!merges'] = [
            { s: { r: 0, c: 0 }, e: { r: 0, c: 4 } },  // Título principal
            { s: { r: 1, c: 0 }, e: { r: 1, c: 4 } }   // Subtítulo
        ];

        XLSX.utils.book_append_sheet(wb, wsPruebas, 'Catalogo de Pruebas');
        {% endif %}

        // Guardar archivo
        XLSX.writeFile(wb, `Dashboard_Laboratorio_Perez_${new Date().toISOString().split('T')[0]}.xlsx`);

        // Restaurar botón
        btnExcel.innerHTML = '<i class="fas fa-check"></i> Excel Generado!';
        setTimeout(() => {
            btnExcel.innerHTML = originalHTML;
            btnExcel.disabled = false;
        }, 2000);

    } catch (error) {
        console.error('Error generando Excel:', error);
        alert('Error al generar el Excel. Por favor, intente nuevamente.');
        btnExcel.innerHTML = originalHTML;
        btnExcel.disabled = false;
    }
}
</script>
{% endblock %}
