import os
from flask import flash, redirect, url_for

@app.route('/resultados/descargar/<int:resultado_id>')
@login_required
def descargar(resultado_id):
    from app.models import Resultado
    resultado = Resultado.query.get_or_404(resultado_id)
    
    # Verificar permisos
    if not current_user.is_admin and resultado.medico_id != current_user.id:
        flash('No tienes permiso para descargar este resultado.', 'error')
        return redirect(url_for('index'))
    
    # Construir ruta completa
    base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
    ruta_completa = os.path.join(base_dir, resultado.archivo_pdf)
    
    # Verificar que el archivo existe
    if not os.path.exists(ruta_completa):
        flash(f'ERROR: El archivo PDF no existe en el servidor.', 'error')
        app.logger.error(f'Archivo no encontrado: {ruta_completa}')
        
        # Si eres admin, eliminar el registro huérfano
        if current_user.is_admin:
            try:
                db.session.delete(resultado)
                db.session.commit()
                flash('Registro eliminado (archivo no encontrado).', 'warning')
            except Exception as e:
                app.logger.error(f'Error al eliminar: {e}')
        
        return redirect(url_for('admin_resultados' if current_user.is_admin else 'index'))
    
    return send_file(ruta_completa, as_attachment=True)
